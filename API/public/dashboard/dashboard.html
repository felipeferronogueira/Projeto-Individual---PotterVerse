<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../css/chart.css" />
  <title>Implementando o ChartJS</title>
</head>

<body>
  <div class="background">

    <h1>DashBoard</h1>

    <div class="container">
      <div>
        <canvas id="myChart" style="position: relative; height: 40vh; width: 40vw"></canvas>
      </div>
      <div>
        <canvas id="myChart2" style="position: relative; height: 40vh; width: 40vw"></canvas>
      </div>
    </div>

    <div class="footer">
      <div class="container">
        <p style="color: #f50000;">Feito por Felipe Ferro Nogueira - 1CCO - SPTECH &copy </p>
      </div>
    </div>
  </div>
</body> 

</html>

<script>
const ctx = document.getElementById("myChart");
const ctx2 = document.getElementById("myChart2");
var pontuacao = sessionStorage.getItem('pontuacao');    
var erros = 10 - pontuacao;

function obterDadosGrafico(idAquario) {

alterarTitulo(idAquario)

if (proximaAtualizacao != undefined) {
    clearTimeout(proximaAtualizacao);
}

fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idAquario);

        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}

// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
// Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
// A função *plotarGrafico* também invoca a função *atualizarGrafico*
function plotarGrafico(resposta, idAquario) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
    labels: labels,
    datasets: [{
        label: 'Acertos',
        data: [],
        fill: false,
        borderColor: 'white',
        tension: 0.1
    },
    {
        label: 'Erros',
        data: [],
        fill: false,
        borderColor: 'white',
        tension: 0.1
    }]
}; 

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta.length; i++) {
    var registro = resposta[i];
    labels.push(registro.momento_grafico);
    dados.datasets[0].data.push(registro.umidade);
    dados.datasets[1].data.push(registro.temperatura);
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
    type: 'line',
    data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart = new Chart(
    document.getElementById(`myChartCanvas${idAquario}`),
    config
);

setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
}


// Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
// buscando a última medida inserida em tabela contendo as capturas, 

//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
//     Para ajustar o "select", ajuste o comando sql em src/models
function atualizarGrafico(idAquario, dados, myChart) {



fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (novoRegistro) {

            obterdados(idAquario);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(`avisoCaptura${idAquario}`)
            avisoCaptura.innerHTML = ""


            if (novoRegistro[0].momento_grafico == dados.labels[dados.labels.length - 1]) {
                console.log("---------------------------------------------------------------")
                console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                avisoCaptura.innerHTML = "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                console.log("Horário do novo dado capturado:")
                console.log(novoRegistro[0].momento_grafico)
                console.log("Horário do último dado capturado:")
                console.log(dados.labels[dados.labels.length - 1])
                console.log("---------------------------------------------------------------")
            } else {
                // tirando e colocando valores no gráfico
                dados.labels.shift(); // apagar o primeiro
                dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                dados.datasets[0].data.push(novoRegistro[0].umidade); // incluir uma nova medida de umidade

                dados.datasets[1].data.shift();  // apagar o primeiro de temperatura
                dados.datasets[1].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
        // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
        proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });

}

n
  

new Chart(ctx2, {
  type: "bar",
  data: {
    labels: ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho"],
    datasets: [{
        label: "Temperatura Média",
        data: [0 + 22, 10 + 14, 20 + 7, 30 - 7, 40 - 20, 50 - 32],
        borderWidth: 2,
        borderColor: "rgb(0, 153, 180)",
      },
      {
        label: "Umidade Média",
        data: [0 + 90, 10 + 79, 20 + 73, 30 + 57, 40 + 48, 50 + 32],
        borderWidth: 2,
        borderColor: "#f5cc00",
      },
    ],
  },
  options: {
    scales: {
      x: {
        ticks: {
          color: "white", // Cor dos meses (rótulos no eixo x)
        },
        grid: {
          color: 'rgba(255, 255, 255, 0.2)', // Cor das linhas do grid no eixo x (branco com opacidade)
        },
      },
      y: {
        beginAtZero: true,
        ticks: {
          color: "white", // Cor dos valores à esquerda dos meses (eixo y)
        },
        grid: {
          color: 'rgba(255, 255, 255, 0.2)', // Cor das linhas do grid no eixo y (branco com opacidade)
        },
      },
    },
    legend: {
      labels: {
        color: "white", // Cor dos nomes na legenda
      },
    },
    plugins: {
      legend: {
        labels: {
          color: 'white' // Cor dos nomes de dataset (Temperatura Média e Umidade Média)
        }
      }
    },
    layout: {
      padding: {
        left: 10,
        right: 10,
        top: 10,
        bottom: 10
      }
    }
  },
});

  const config = {
    type: "bar",
    data: data,
    options: {},
  };

  function obter(){
    fetch("/usuarios/autenticar")
            .then(function (resposta) {
            console.log("ESTOU NO THEN DO entrar()!")

            if (resposta.ok) {
                console.log(resposta);

                resposta.json().then(json => {
                    console.log(json);
                    console.log(JSON.stringify(json));
                    sessionStorage.EMAIL_USUARIO = json.email;
                    sessionStorage.NOME_USUARIO = json.nome;
                    sessionStorage.CPF = json.cpf;
                    sessionStorage.ID_USUARIO = json.id;
                    sessionStorage.AQUARIOS = JSON.stringify(json.aquarios)

                    setTimeout(function () {
                        window.location = "./dashboard/conteudo.html";
                    }, 1000); // apenas para exibir o loading

                });

            } else {

                console.log("Houve um erro ao tentar realizar o login!");

                resposta.text().then(texto => {
                    console.error(texto);
                    finalizarAguardar(texto);
                });
            }

        }).catch(function (erro) {
            console.log(erro);
        })

        return false;
    }
</script>

<script>
  const myChart = new Chart(document.getElementById("myChart"), config);
  const myChart2 = new Chart(document.getElementById("myChart2"), config2);
</script>